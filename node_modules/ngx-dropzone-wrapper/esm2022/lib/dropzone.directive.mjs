import { Dropzone } from "dropzone";
import { PLATFORM_ID } from "@angular/core";
import { isPlatformBrowser } from "@angular/common";
import { Inject, Optional, Directive, Input, Output, EventEmitter, } from "@angular/core";
import { DROPZONE_CONFIG, DropzoneConfig, DropzoneEvents, } from "./dropzone.interfaces";
import * as i0 from "@angular/core";
export class DropzoneDirective {
    zone;
    renderer;
    elementRef;
    differs;
    platformId;
    defaults;
    instance;
    configDiff = null;
    disabled = false;
    config;
    DZ_INIT = new EventEmitter();
    DZ_ERROR = new EventEmitter();
    DZ_SUCCESS = new EventEmitter();
    DZ_SENDING = new EventEmitter();
    DZ_CANCELED = new EventEmitter();
    DZ_COMPLETE = new EventEmitter();
    DZ_PROCESSING = new EventEmitter();
    DZ_DROP = new EventEmitter();
    DZ_DRAGSTART = new EventEmitter();
    DZ_DRAGEND = new EventEmitter();
    DZ_DRAGENTER = new EventEmitter();
    DZ_DRAGOVER = new EventEmitter();
    DZ_DRAGLEAVE = new EventEmitter();
    DZ_THUMBNAIL = new EventEmitter();
    DZ_ADDEDFILE = new EventEmitter();
    DZ_ADDEDFILES = new EventEmitter();
    DZ_REMOVEDFILE = new EventEmitter();
    DZ_UPLOADPROGRESS = new EventEmitter();
    DZ_MAXFILESREACHED = new EventEmitter();
    DZ_MAXFILESEXCEEDED = new EventEmitter();
    DZ_ERRORMULTIPLE = new EventEmitter();
    DZ_SUCCESSMULTIPLE = new EventEmitter();
    DZ_SENDINGMULTIPLE = new EventEmitter();
    DZ_CANCELEDMULTIPLE = new EventEmitter();
    DZ_COMPLETEMULTIPLE = new EventEmitter();
    DZ_PROCESSINGMULTIPLE = new EventEmitter();
    DZ_RESET = new EventEmitter();
    DZ_QUEUECOMPLETE = new EventEmitter();
    DZ_TOTALUPLOADPROGRESS = new EventEmitter();
    constructor(zone, renderer, elementRef, differs, platformId, defaults) {
        this.zone = zone;
        this.renderer = renderer;
        this.elementRef = elementRef;
        this.differs = differs;
        this.platformId = platformId;
        this.defaults = defaults;
        const dz = Dropzone;
        dz.autoDiscover = false;
    }
    ngOnInit() {
        if (!isPlatformBrowser(this.platformId)) {
            return;
        }
        const params = new DropzoneConfig(this.defaults);
        params.assign(this.config); // Custom configuration
        this.renderer.addClass(this.elementRef.nativeElement, params.maxFiles === 1 ? "dz-single" : "dz-multiple");
        this.renderer.removeClass(this.elementRef.nativeElement, params.maxFiles === 1 ? "dz-multiple" : "dz-single");
        Object.keys(params).forEach(key => params[key] === undefined && delete params[key]);
        this.zone.runOutsideAngular(() => {
            console.log(params);
            this.instance = new Dropzone(this.elementRef.nativeElement, params);
        });
        if (this.disabled) {
            this.instance.disable();
        }
        if (this.DZ_INIT.observers.length) {
            this.zone.run(() => {
                this.DZ_INIT.emit(this.instance);
            });
        }
        // Add auto reset handling for events
        this.instance.on("success", () => {
            if (params.autoReset != null) {
                setTimeout(() => this.reset(), params.autoReset);
            }
        });
        this.instance.on("error", () => {
            if (params.errorReset != null) {
                setTimeout(() => this.reset(), params.errorReset);
            }
        });
        this.instance.on("canceled", () => {
            if (params.cancelReset != null) {
                setTimeout(() => this.reset(), params.cancelReset);
            }
        });
        // Add native Dropzone event handling
        DropzoneEvents.forEach((eventName) => {
            this.instance.on(eventName.toLowerCase(), (...args) => {
                args = args.length === 1 ? args[0] : args;
                const output = `DZ_${eventName.toUpperCase()}`;
                const emitter = this[output];
                if (emitter.observers.length > 0) {
                    this.zone.run(() => {
                        emitter.emit(args);
                    });
                }
            });
        });
        if (!this.configDiff) {
            this.configDiff = this.differs.find(this.config || {}).create();
            this.configDiff.diff(this.config || {});
        }
    }
    ngOnDestroy() {
        if (this.instance) {
            this.zone.runOutsideAngular(() => {
                this.instance.destroy();
            });
            this.instance = null;
        }
    }
    ngDoCheck() {
        if (!this.disabled && this.configDiff) {
            const changes = this.configDiff.diff(this.config || {});
            if (changes && this.instance) {
                this.ngOnDestroy();
                this.ngOnInit();
            }
        }
    }
    ngOnChanges(changes) {
        if (this.instance && changes["disabled"]) {
            if (changes["disabled"].currentValue !== changes["disabled"].previousValue) {
                if (changes["disabled"].currentValue === false) {
                    this.zone.runOutsideAngular(() => {
                        this.instance.enable();
                    });
                }
                else if (changes["disabled"].currentValue === true) {
                    this.zone.runOutsideAngular(() => {
                        this.instance.disable();
                    });
                }
            }
        }
    }
    dropzone() {
        return this.instance;
    }
    reset(cancel) {
        if (this.instance) {
            this.zone.runOutsideAngular(() => {
                this.instance.removeAllFiles(cancel);
            });
        }
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.4", ngImport: i0, type: DropzoneDirective, deps: [{ token: i0.NgZone }, { token: i0.Renderer2 }, { token: i0.ElementRef }, { token: i0.KeyValueDiffers }, { token: PLATFORM_ID }, { token: DROPZONE_CONFIG, optional: true }], target: i0.ɵɵFactoryTarget.Directive });
    static ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "17.0.4", type: DropzoneDirective, selector: "[dropzone]", inputs: { disabled: "disabled", config: ["dropzone", "config"] }, outputs: { DZ_INIT: "init", DZ_ERROR: "error", DZ_SUCCESS: "success", DZ_SENDING: "sending", DZ_CANCELED: "canceled", DZ_COMPLETE: "complete", DZ_PROCESSING: "processing", DZ_DROP: "drop", DZ_DRAGSTART: "dragStart", DZ_DRAGEND: "dragEnd", DZ_DRAGENTER: "dragEnter", DZ_DRAGOVER: "dragOver", DZ_DRAGLEAVE: "dragLeave", DZ_THUMBNAIL: "thumbnail", DZ_ADDEDFILE: "addedFile", DZ_ADDEDFILES: "addedFiles", DZ_REMOVEDFILE: "removedFile", DZ_UPLOADPROGRESS: "uploadProgress", DZ_MAXFILESREACHED: "maxFilesReached", DZ_MAXFILESEXCEEDED: "maxFilesExceeded", DZ_ERRORMULTIPLE: "errorMultiple", DZ_SUCCESSMULTIPLE: "successMultiple", DZ_SENDINGMULTIPLE: "sendingMultiple", DZ_CANCELEDMULTIPLE: "canceledMultiple", DZ_COMPLETEMULTIPLE: "completeMultiple", DZ_PROCESSINGMULTIPLE: "processingMultiple", DZ_RESET: "reset", DZ_QUEUECOMPLETE: "queueComplete", DZ_TOTALUPLOADPROGRESS: "totalUploadProgress" }, exportAs: ["ngxDropzone"], usesOnChanges: true, ngImport: i0 });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.4", ngImport: i0, type: DropzoneDirective, decorators: [{
            type: Directive,
            args: [{
                    selector: "[dropzone]",
                    exportAs: "ngxDropzone",
                }]
        }], ctorParameters: () => [{ type: i0.NgZone }, { type: i0.Renderer2 }, { type: i0.ElementRef }, { type: i0.KeyValueDiffers }, { type: Object, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: undefined, decorators: [{
                    type: Optional
                }, {
                    type: Inject,
                    args: [DROPZONE_CONFIG]
                }] }], propDecorators: { disabled: [{
                type: Input
            }], config: [{
                type: Input,
                args: ["dropzone"]
            }], DZ_INIT: [{
                type: Output,
                args: ["init"]
            }], DZ_ERROR: [{
                type: Output,
                args: ["error"]
            }], DZ_SUCCESS: [{
                type: Output,
                args: ["success"]
            }], DZ_SENDING: [{
                type: Output,
                args: ["sending"]
            }], DZ_CANCELED: [{
                type: Output,
                args: ["canceled"]
            }], DZ_COMPLETE: [{
                type: Output,
                args: ["complete"]
            }], DZ_PROCESSING: [{
                type: Output,
                args: ["processing"]
            }], DZ_DROP: [{
                type: Output,
                args: ["drop"]
            }], DZ_DRAGSTART: [{
                type: Output,
                args: ["dragStart"]
            }], DZ_DRAGEND: [{
                type: Output,
                args: ["dragEnd"]
            }], DZ_DRAGENTER: [{
                type: Output,
                args: ["dragEnter"]
            }], DZ_DRAGOVER: [{
                type: Output,
                args: ["dragOver"]
            }], DZ_DRAGLEAVE: [{
                type: Output,
                args: ["dragLeave"]
            }], DZ_THUMBNAIL: [{
                type: Output,
                args: ["thumbnail"]
            }], DZ_ADDEDFILE: [{
                type: Output,
                args: ["addedFile"]
            }], DZ_ADDEDFILES: [{
                type: Output,
                args: ["addedFiles"]
            }], DZ_REMOVEDFILE: [{
                type: Output,
                args: ["removedFile"]
            }], DZ_UPLOADPROGRESS: [{
                type: Output,
                args: ["uploadProgress"]
            }], DZ_MAXFILESREACHED: [{
                type: Output,
                args: ["maxFilesReached"]
            }], DZ_MAXFILESEXCEEDED: [{
                type: Output,
                args: ["maxFilesExceeded"]
            }], DZ_ERRORMULTIPLE: [{
                type: Output,
                args: ["errorMultiple"]
            }], DZ_SUCCESSMULTIPLE: [{
                type: Output,
                args: ["successMultiple"]
            }], DZ_SENDINGMULTIPLE: [{
                type: Output,
                args: ["sendingMultiple"]
            }], DZ_CANCELEDMULTIPLE: [{
                type: Output,
                args: ["canceledMultiple"]
            }], DZ_COMPLETEMULTIPLE: [{
                type: Output,
                args: ["completeMultiple"]
            }], DZ_PROCESSINGMULTIPLE: [{
                type: Output,
                args: ["processingMultiple"]
            }], DZ_RESET: [{
                type: Output,
                args: ["reset"]
            }], DZ_QUEUECOMPLETE: [{
                type: Output,
                args: ["queueComplete"]
            }], DZ_TOTALUPLOADPROGRESS: [{
                type: Output,
                args: ["totalUploadProgress"]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHJvcHpvbmUuZGlyZWN0aXZlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcHJvamVjdHMvbGliL3NyYy9saWIvZHJvcHpvbmUuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFcEMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBRUwsTUFBTSxFQUNOLFFBQVEsRUFHUixTQUFTLEVBS1QsS0FBSyxFQUNMLE1BQU0sRUFDTixZQUFZLEdBSWIsTUFBTSxlQUFlLENBQUM7QUFFdkIsT0FBTyxFQUNMLGVBQWUsRUFDZixjQUFjLEVBR2QsY0FBYyxHQUNmLE1BQU0sdUJBQXVCLENBQUM7O0FBTS9CLE1BQU0sT0FBTyxpQkFBaUI7SUFnRGxCO0lBQ0E7SUFDQTtJQUNBO0lBQ3FCO0lBR3JCO0lBcERGLFFBQVEsQ0FBTTtJQUVkLFVBQVUsR0FBdUMsSUFBSSxDQUFDO0lBRXJELFFBQVEsR0FBWSxLQUFLLENBQUM7SUFFaEIsTUFBTSxDQUEyQjtJQUVwQyxPQUFPLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUVqQyxRQUFRLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUNqQyxVQUFVLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUNyQyxVQUFVLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUNwQyxXQUFXLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUN0QyxXQUFXLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUNwQyxhQUFhLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUU5QyxPQUFPLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUM3QixZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQU8sQ0FBQztJ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O3NCQUFoQyxNQUFNO3VCQUFDLFdBQVc7Z0JBQ0MsV0FBVztzQkFBOUIsTUFBTTt1QkFBQyxVQUFVO2dCQUNHLFlBQVk7c0JBQWhDLE1BQU07dUJBQUMsV0FBVztnQkFFRSxZQUFZO3NCQUFoQyxNQUFNO3VCQUFDLFdBQVc7Z0JBQ0UsWUFBWTtzQkFBaEMsTUFBTTt1QkFBQyxXQUFXO2dCQUNHLGFBQWE7c0JBQWxDLE1BQU07dUJBQUMsWUFBWTtnQkFDRyxjQUFjO3NCQUFwQyxNQUFNO3VCQUFDLGFBQWE7Z0JBQ0ssaUJBQWlCO3NCQUExQyxNQUFNO3VCQUFDLGdCQUFnQjtnQkFDRyxrQkFBa0I7c0JBQTVDLE1BQU07dUJBQUMsaUJBQWlCO2dCQUNHLG1CQUFtQjtzQkFBOUMsTUFBTTt1QkFBQyxrQkFBa0I7Z0JBRUQsZ0JBQWdCO3NCQUF4QyxNQUFNO3VCQUFDLGVBQWU7Z0JBQ0ksa0JBQWtCO3NCQUE1QyxNQUFNO3VCQUFDLGlCQUFpQjtnQkFDRSxrQkFBa0I7c0JBQTVDLE1BQU07dUJBQUMsaUJBQWlCO2dCQUNHLG1CQUFtQjtzQkFBOUMsTUFBTTt1QkFBQyxrQkFBa0I7Z0JBQ0UsbUJBQW1CO3NCQUE5QyxNQUFNO3VCQUFDLGtCQUFrQjtnQkFDSSxxQkFBcUI7c0JBQWxELE1BQU07dUJBQUMsb0JBQW9CO2dCQUVYLFFBQVE7c0JBQXhCLE1BQU07dUJBQUMsT0FBTztnQkFDVSxnQkFBZ0I7c0JBQXhDLE1BQU07dUJBQUMsZUFBZTtnQkFDUSxzQkFBc0I7c0JBQXBELE1BQU07dUJBQUMscUJBQXFCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRHJvcHpvbmUgfSBmcm9tIFwiZHJvcHpvbmVcIjtcblxuaW1wb3J0IHsgUExBVEZPUk1fSUQgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uXCI7XG5pbXBvcnQge1xuICBOZ1pvbmUsXG4gIEluamVjdCxcbiAgT3B0aW9uYWwsXG4gIEVsZW1lbnRSZWYsXG4gIFJlbmRlcmVyMixcbiAgRGlyZWN0aXZlLFxuICBPbkluaXQsXG4gIE9uRGVzdHJveSxcbiAgRG9DaGVjayxcbiAgT25DaGFuZ2VzLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBFdmVudEVtaXR0ZXIsXG4gIFNpbXBsZUNoYW5nZXMsXG4gIEtleVZhbHVlRGlmZmVyLFxuICBLZXlWYWx1ZURpZmZlcnMsXG59IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5cbmltcG9ydCB7XG4gIERST1BaT05FX0NPTkZJRyxcbiAgRHJvcHpvbmVDb25maWcsXG4gIERyb3B6b25lQ29uZmlnSW50ZXJmYWNlLFxuICBEcm9wem9uZUV2ZW50LFxuICBEcm9wem9uZUV2ZW50cyxcbn0gZnJvbSBcIi4vZHJvcHpvbmUuaW50ZXJmYWNlc1wiO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6IFwiW2Ryb3B6b25lXVwiLFxuICBleHBvcnRBczogXCJuZ3hEcm9wem9uZVwiLFxufSlcbmV4cG9ydCBjbGFzcyBEcm9wem9uZURpcmVjdGl2ZVxuICBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95LCBEb0NoZWNrLCBPbkNoYW5nZXNcbntcbiAgcHJpdmF0ZSBpbnN0YW5jZTogYW55O1xuXG4gIHByaXZhdGUgY29uZmlnRGlmZjogS2V5VmFsdWVEaWZmZXI8c3RyaW5nLCBhbnk+IHwgbnVsbCA9IG51bGw7XG5cbiAgQElucHV0KCkgZGlzYWJsZWQ6IGJvb2xlYW4gPSBmYWxzZTtcblxuICBASW5wdXQoXCJkcm9wem9uZVwiKSBjb25maWc/OiBEcm9wem9uZUNvbmZpZ0ludGVyZmFjZTtcblxuICBAT3V0cHV0KFwiaW5pdFwiKSBEWl9JTklUID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgQE91dHB1dChcImVycm9yXCIpIERaX0VSUk9SID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJzdWNjZXNzXCIpIERaX1NVQ0NFU1MgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dChcInNlbmRpbmdcIikgRFpfU0VORElORyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KFwiY2FuY2VsZWRcIikgRFpfQ0FOQ0VMRUQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dChcImNvbXBsZXRlXCIpIERaX0NPTVBMRVRFID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJwcm9jZXNzaW5nXCIpIERaX1BST0NFU1NJTkcgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KFwiZHJvcFwiKSBEWl9EUk9QID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJkcmFnU3RhcnRcIikgRFpfRFJBR1NUQVJUID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJkcmFnRW5kXCIpIERaX0RSQUdFTkQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dChcImRyYWdFbnRlclwiKSBEWl9EUkFHRU5URVIgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dChcImRyYWdPdmVyXCIpIERaX0RSQUdPVkVSID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJkcmFnTGVhdmVcIikgRFpfRFJBR0xFQVZFID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgQE91dHB1dChcInRodW1ibmFpbFwiKSBEWl9USFVNQk5BSUwgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dChcImFkZGVkRmlsZVwiKSBEWl9BRERFREZJTEUgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dChcImFkZGVkRmlsZXNcIikgRFpfQURERURGSUxFUyA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KFwicmVtb3ZlZEZpbGVcIikgRFpfUkVNT1ZFREZJTEUgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dChcInVwbG9hZFByb2dyZXNzXCIpIERaX1VQTE9BRFBST0dSRVNTID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJtYXhGaWxlc1JlYWNoZWRcIikgRFpfTUFYRklMRVNSRUFDSEVEID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJtYXhGaWxlc0V4Y2VlZGVkXCIpIERaX01BWEZJTEVTRVhDRUVERUQgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KFwiZXJyb3JNdWx0aXBsZVwiKSBEWl9FUlJPUk1VTFRJUExFID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJzdWNjZXNzTXVsdGlwbGVcIikgRFpfU1VDQ0VTU01VTFRJUExFID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJzZW5kaW5nTXVsdGlwbGVcIikgRFpfU0VORElOR01VTFRJUExFID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJjYW5jZWxlZE11bHRpcGxlXCIpIERaX0NBTkNFTEVETVVMVElQTEUgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcbiAgQE91dHB1dChcImNvbXBsZXRlTXVsdGlwbGVcIikgRFpfQ09NUExFVEVNVUxUSVBMRSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KFwicHJvY2Vzc2luZ011bHRpcGxlXCIpIERaX1BST0NFU1NJTkdNVUxUSVBMRSA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoXCJyZXNldFwiKSBEWl9SRVNFVCA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuICBAT3V0cHV0KFwicXVldWVDb21wbGV0ZVwiKSBEWl9RVUVVRUNPTVBMRVRFID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG4gIEBPdXRwdXQoXCJ0b3RhbFVwbG9hZFByb2dyZXNzXCIpIERaX1RPVEFMVVBMT0FEUFJPR1JFU1MgPVxuICAgIG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgem9uZTogTmdab25lLFxuICAgIHByaXZhdGUgcmVuZGVyZXI6IFJlbmRlcmVyMixcbiAgICBwcml2YXRlIGVsZW1lbnRSZWY6IEVsZW1lbnRSZWYsXG4gICAgcHJpdmF0ZSBkaWZmZXJzOiBLZXlWYWx1ZURpZmZlcnMsXG4gICAgQEluamVjdChQTEFURk9STV9JRCkgcHJpdmF0ZSBwbGF0Zm9ybUlkOiBPYmplY3QsXG4gICAgQE9wdGlvbmFsKClcbiAgICBASW5qZWN0KERST1BaT05FX0NPTkZJRylcbiAgICBwcml2YXRlIGRlZmF1bHRzOiBEcm9wem9uZUNvbmZpZ0ludGVyZmFjZVxuICApIHtcbiAgICBjb25zdCBkeiA9IERyb3B6b25lO1xuXG4gICAgZHouYXV0b0Rpc2NvdmVyID0gZmFsc2U7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm1JZCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJhbXMgPSBuZXcgRHJvcHpvbmVDb25maWcodGhpcy5kZWZhdWx0cyk7XG5cbiAgICBwYXJhbXMuYXNzaWduKHRoaXMuY29uZmlnKTsgLy8gQ3VzdG9tIGNvbmZpZ3VyYXRpb25cblxuICAgIHRoaXMucmVuZGVyZXIuYWRkQ2xhc3MoXG4gICAgICB0aGlzLmVsZW1lbnRSZWYubmF0aXZlRWxlbWVudCxcbiAgICAgIHBhcmFtcy5tYXhGaWxlcyA9PT0gMSA/IFwiZHotc2luZ2xlXCIgOiBcImR6LW11bHRpcGxlXCJcbiAgICApO1xuXG4gICAgdGhpcy5yZW5kZXJlci5yZW1vdmVDbGFzcyhcbiAgICAgIHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LFxuICAgICAgcGFyYW1zLm1heEZpbGVzID09PSAxID8gXCJkei1tdWx0aXBsZVwiIDogXCJkei1zaW5nbGVcIlxuICAgICk7XG5cbiAgICBPYmplY3Qua2V5cyhwYXJhbXMpLmZvckVhY2goa2V5ID0+IHBhcmFtc1trZXldID09PSB1bmRlZmluZWQgJiYgZGVsZXRlIHBhcmFtc1trZXldKVxuXG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgIGNvbnNvbGUubG9nKHBhcmFtcyk7XG4gICAgICB0aGlzLmluc3RhbmNlID0gbmV3IERyb3B6b25lKHRoaXMuZWxlbWVudFJlZi5uYXRpdmVFbGVtZW50LCBwYXJhbXMpO1xuICAgIH0pO1xuXG4gICAgaWYgKHRoaXMuZGlzYWJsZWQpIHtcbiAgICAgIHRoaXMuaW5zdGFuY2UuZGlzYWJsZSgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLkRaX0lOSVQub2JzZXJ2ZXJzLmxlbmd0aCkge1xuICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7XG4gICAgICAgIHRoaXMuRFpfSU5JVC5lbWl0KHRoaXMuaW5zdGFuY2UpO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQWRkIGF1dG8gcmVzZXQgaGFuZGxpbmcgZm9yIGV2ZW50c1xuICAgIHRoaXMuaW5zdGFuY2Uub24oXCJzdWNjZXNzXCIsICgpID0+IHtcbiAgICAgIGlmIChwYXJhbXMuYXV0b1Jlc2V0ICE9IG51bGwpIHtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLnJlc2V0KCksIHBhcmFtcy5hdXRvUmVzZXQpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgdGhpcy5pbnN0YW5jZS5vbihcImVycm9yXCIsICgpID0+IHtcbiAgICAgIGlmIChwYXJhbXMuZXJyb3JSZXNldCAhPSBudWxsKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZXNldCgpLCBwYXJhbXMuZXJyb3JSZXNldCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB0aGlzLmluc3RhbmNlLm9uKFwiY2FuY2VsZWRcIiwgKCkgPT4ge1xuICAgICAgaWYgKHBhcmFtcy5jYW5jZWxSZXNldCAhPSBudWxsKSB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4gdGhpcy5yZXNldCgpLCBwYXJhbXMuY2FuY2VsUmVzZXQpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgLy8gQWRkIG5hdGl2ZSBEcm9wem9uZSBldmVudCBoYW5kbGluZ1xuICAgIERyb3B6b25lRXZlbnRzLmZvckVhY2goKGV2ZW50TmFtZTogRHJvcHpvbmVFdmVudCkgPT4ge1xuICAgICAgdGhpcy5pbnN0YW5jZS5vbihldmVudE5hbWUudG9Mb3dlckNhc2UoKSwgKC4uLmFyZ3M6IGFueVtdKSA9PiB7XG4gICAgICAgIGFyZ3MgPSBhcmdzLmxlbmd0aCA9PT0gMSA/IGFyZ3NbMF0gOiBhcmdzO1xuXG4gICAgICAgIGNvbnN0IG91dHB1dCA9IGBEWl8ke2V2ZW50TmFtZS50b1VwcGVyQ2FzZSgpfWA7XG5cbiAgICAgICAgY29uc3QgZW1pdHRlciA9IHRoaXNbXG4gICAgICAgICAgb3V0cHV0IGFzIGtleW9mIERyb3B6b25lRGlyZWN0aXZlXG4gICAgICAgIF0gYXMgRXZlbnRFbWl0dGVyPGFueT47XG5cbiAgICAgICAgaWYgKGVtaXR0ZXIub2JzZXJ2ZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHtcbiAgICAgICAgICAgIGVtaXR0ZXIuZW1pdChhcmdzKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpZiAoIXRoaXMuY29uZmlnRGlmZikge1xuICAgICAgdGhpcy5jb25maWdEaWZmID0gdGhpcy5kaWZmZXJzLmZpbmQodGhpcy5jb25maWcgfHwge30pLmNyZWF0ZSgpO1xuXG4gICAgICB0aGlzLmNvbmZpZ0RpZmYuZGlmZih0aGlzLmNvbmZpZyB8fCB7fSk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaW5zdGFuY2UpIHtcbiAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgIHRoaXMuaW5zdGFuY2UuZGVzdHJveSgpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMuaW5zdGFuY2UgPSBudWxsO1xuICAgIH1cbiAgfVxuXG4gIG5nRG9DaGVjaygpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuZGlzYWJsZWQgJiYgdGhpcy5jb25maWdEaWZmKSB7XG4gICAgICBjb25zdCBjaGFuZ2VzID0gdGhpcy5jb25maWdEaWZmLmRpZmYodGhpcy5jb25maWcgfHwge30pO1xuXG4gICAgICBpZiAoY2hhbmdlcyAmJiB0aGlzLmluc3RhbmNlKSB7XG4gICAgICAgIHRoaXMubmdPbkRlc3Ryb3koKTtcblxuICAgICAgICB0aGlzLm5nT25Jbml0KCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbmdPbkNoYW5nZXMoY2hhbmdlczogU2ltcGxlQ2hhbmdlcyk6IHZvaWQge1xuICAgIGlmICh0aGlzLmluc3RhbmNlICYmIGNoYW5nZXNbXCJkaXNhYmxlZFwiXSkge1xuICAgICAgaWYgKFxuICAgICAgICBjaGFuZ2VzW1wiZGlzYWJsZWRcIl0uY3VycmVudFZhbHVlICE9PSBjaGFuZ2VzW1wiZGlzYWJsZWRcIl0ucHJldmlvdXNWYWx1ZVxuICAgICAgKSB7XG4gICAgICAgIGlmIChjaGFuZ2VzW1wiZGlzYWJsZWRcIl0uY3VycmVudFZhbHVlID09PSBmYWxzZSkge1xuICAgICAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmluc3RhbmNlLmVuYWJsZSgpO1xuICAgICAgICAgIH0pO1xuICAgICAgICB9IGVsc2UgaWYgKGNoYW5nZXNbXCJkaXNhYmxlZFwiXS5jdXJyZW50VmFsdWUgPT09IHRydWUpIHtcbiAgICAgICAgICB0aGlzLnpvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5pbnN0YW5jZS5kaXNhYmxlKCk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZHJvcHpvbmUoKTogYW55IHtcbiAgICByZXR1cm4gdGhpcy5pbnN0YW5jZTtcbiAgfVxuXG4gIHB1YmxpYyByZXNldChjYW5jZWw/OiBib29sZWFuKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaW5zdGFuY2UpIHtcbiAgICAgIHRoaXMuem9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgIHRoaXMuaW5zdGFuY2UucmVtb3ZlQWxsRmlsZXMoY2FuY2VsKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufVxuIl19